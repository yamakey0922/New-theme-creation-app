<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Materials Strategy Tri-Agent Studio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- ====== CSS ====== -->
    <style>
        :root {
            --bg: #0f172a;
            --bg-soft: #111827;
            --bg-softer: #020817;
            --border-subtle: #1f2937;
            --accent: #38bdf8;
            --accent-soft: rgba(56,189,248,0.18);
            --accent-gemini: #22c55e;
            --accent-chatgpt: #6366f1;
            --accent-engineer: #f97316;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --radius-xl: 18px;
            --radius-md: 10px;
            --shadow-soft: 0 18px 40px rgba(15,23,42,0.75);
            --transition-fast: 0.18s ease;
            --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", -system-ui, sans-serif;
            --badge-size: 11px;
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-sans);
            background: radial-gradient(circle at top left, #111827, #020817 55%);
            color: var(--text);
            -webkit-font-smoothing: antialiased;
        }
        .app-shell {
            max-width: 1240px;
            margin: 24px auto;
            padding: 18px 18px 22px;
            background: radial-gradient(circle at top, rgba(56,189,248,0.04), transparent 70%) fixed,
                        rgba(2,6,23,0.96);
            border-radius: 28px;
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(148,163,253,0.14);
            backdrop-filter: blur(20px);
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            padding: 8px 6px 14px;
            border-bottom: 1px solid var(--border-subtle);
        }
        .title-block h1 {
            margin: 0;
            font-size: 22px;
            letter-spacing: 0.03em;
        }
        .title-sub {
            margin-top: 4px;
            font-size: 11px;
            color: var(--muted);
        }
        .role-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 9px;
            border: 1px solid rgba(156,163,175,0.38);
            color: var(--muted);
            background: rgba(9,9,11,0.85);
        }
        .pill span.badge {
            width: var(--badge-size);
            height: var(--badge-size);
            border-radius: 999px;
            display: inline-block;
        }
        .pill.chatgpt .badge { background: var(--accent-chatgpt); }
        .pill.gemini .badge { background: var(--accent-gemini); }
        .pill.engineer .badge { background: var(--accent-engineer); }

        .config {
            display: grid;
            grid-template-columns: 2.2fr 1.8fr;
            gap: 14px;
            padding: 10px 6px 10px;
            border-bottom: 1px solid var(--border-subtle);
        }
        .config-block {
            padding: 10px 10px 8px;
            border-radius: 16px;
            background: radial-gradient(circle at top, rgba(15,23,42,0.6), rgba(9,9,11,0.96));
            border: 1px solid rgba(75,85,99,0.7);
        }
        .config-block h2 {
            margin: 0 0 4px;
            font-size: 11px;
            color: var(--muted);
            font-weight: 500;
        }
        .field-row {
            display: grid;
            grid-template-columns: 110px 1fr;
            gap: 6px;
            margin-bottom: 4px;
            align-items: center;
        }
        .field-row label {
            font-size: 9px;
            color: var(--muted);
        }
        .field-row input {
            font-size: 10px;
            padding: 5px 7px;
            border-radius: 8px;
            border: 1px solid rgba(75,85,99,0.9);
            background: rgba(2,6,23,0.98);
            color: var(--text);
            width: 100%;
            outline: none;
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
        }
        .field-row input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(56,189,248,0.25);
            background: #020817;
        }
        .hint {
            font-size: 8px;
            color: var(--muted);
            margin-top: 4px;
            line-height: 1.6;
        }

        .persona-brief {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 5px;
        }
        .persona-card {
            padding: 6px 8px;
            border-radius: 10px;
            background: radial-gradient(circle at top, rgba(15,23,42,0.7), rgba(9,9,11,0.98));
            border: 1px solid rgba(75,85,99,0.9);
            font-size: 8px;
            color: var(--muted);
        }
        .persona-card strong {
            display: block;
            font-size: 9px;
            margin-bottom: 2px;
            color: var(--accent);
        }

        .main {
            display: grid;
            grid-template-columns: minmax(0, 2.4fr) minmax(260px, 1.6fr);
            gap: 12px;
            margin-top: 10px;
        }

        .chat-panel {
            display: flex;
            flex-direction: column;
            padding: 10px;
            border-radius: var(--radius-xl);
            border: 1px solid rgba(75,85,99,0.85);
            background:
                radial-gradient(circle at top left, rgba(56,189,248,0.03), transparent 70%),
                rgba(6,8,20,0.98);
            min-height: 420px;
        }
        .chat-log {
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
            margin-bottom: 6px;
            scrollbar-width: thin;
        }
        .chat-log::-webkit-scrollbar {
            width: 6px;
        }
        .chat-log::-webkit-scrollbar-thumb {
            background: rgba(75,85,99,0.8);
            border-radius: 999px;
        }

        .msg-row {
            display: flex;
            margin-bottom: 6px;
        }
        .msg {
            max-width: 92%;
            padding: 7px 9px 7px;
            border-radius: 12px;
            font-size: 10px;
            line-height: 1.6;
            position: relative;
            border: 1px solid transparent;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .msg-header {
            font-size: 8px;
            margin-bottom: 2px;
            opacity: 0.82;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .msg-header span.dot {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            display: inline-block;
        }

        .msg.engineer {
            margin-left: auto;
            background: linear-gradient(to right, rgba(248,250,252,0.06), rgba(249,115,22,0.1));
            border-color: rgba(249,115,22,0.38);
            color: var(--text);
        }
        .msg.engineer .msg-header .dot { background: var(--accent-engineer); }

        .msg.chatgpt {
            margin-right: auto;
            background: linear-gradient(to left, rgba(15,23,42,0.98), rgba(99,102,241,0.16));
            border-color: rgba(99,102,241,0.55);
        }
        .msg.chatgpt .msg-header .dot { background: var(--accent-chatgpt); }

        .msg.gemini {
            margin-right: auto;
            background: linear-gradient(to left, rgba(9,9,11,0.98), rgba(34,197,94,0.11));
            border-color: rgba(34,197,94,0.55);
        }
        .msg.gemini .msg-header .dot { background: var(--accent-gemini); }

        .msg.system {
            margin: 0 auto 6px;
            background: rgba(15,23,42,0.98);
            border-color: rgba(148,163,253,0.34);
            font-size: 8px;
            color: var(--muted);
        }

        .input-bar {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 6px;
            align-items: stretch;
            margin-top: 2px;
        }
        .input-bar textarea {
            resize: none;
            max-height: 80px;
            min-height: 40px;
            padding: 6px 8px;
            font-size: 10px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(75,85,99,0.9);
            background: rgba(2,6,23,0.98);
            color: var(--text);
            outline: none;
            line-height: 1.6;
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
        }
        .input-bar textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(56,189,248,0.25);
            background: #020817;
        }
        button {
            border: none;
            outline: none;
            cursor: pointer;
            border-radius: 999px;
            padding: 0 11px;
            font-size: 9px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all var(--transition-fast);
            white-space: nowrap;
        }
        .btn-send {
            background: linear-gradient(to right, var(--accent), #60a5fa);
            color: #020817;
            font-weight: 600;
        }
        .btn-send:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(37,99,235,0.35);
        }
        .btn-mic {
            background: rgba(15,23,42,1);
            color: var(--accent);
            border-radius: 11px;
            border: 1px solid rgba(56,189,248,0.5);
            padding-inline: 8px;
        }
        .btn-mic.recording {
            background: rgba(248,113,22,0.12);
            color: #fb923c;
            border-color: #fb923c;
            box-shadow: 0 0 10px rgba(248,113,22,0.6);
        }
        .btn-end {
            background: rgba(15,23,42,1);
            color: #f97316;
            border-radius: 11px;
            border: 1px solid rgba(249,115,22,0.6);
            padding-inline: 9px;
        }
        .btn-end:hover {
            background: rgba(249,115,22,0.12);
        }
        .btn-clear {
            background: rgba(9,9,11,0.98);
            color: var(--muted);
            border-radius: 11px;
            border: 1px solid rgba(75,85,99,0.9);
            padding-inline: 8px;
        }
        .btn-clear:hover {
            background: rgba(17,24,39,1);
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .panel {
            padding: 8px 9px;
            border-radius: 16px;
            border: 1px solid rgba(75,85,99,0.85);
            background: rgba(4,7,20,0.98);
            font-size: 8px;
            color: var(--muted);
        }
        .panel h3 {
            margin: 0 0 4px;
            font-size: 10px;
            color: var(--accent);
            font-weight: 500;
        }
        .panel code {
            font-size: 7px;
            background: rgba(15,23,42,0.96);
            padding: 2px 4px;
            border-radius: 5px;
            border: 1px solid rgba(75,85,99,0.9);
            display: block;
            margin-top: 2px;
            white-space: pre-wrap;
        }
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            display: inline-block;
            margin-right: 4px;
        }
        .status-ok { background: #22c55e; }
        .status-warn { background: #f97316; }
        .status-bad { background: #ef4444; }
        .small-label {
            font-size: 7px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
<div class="app-shell">

    <!-- ====== HEADER ====== -->
    <header>
        <div class="title-block">
            <h1>Materials Strategy Tri-Agent Studio</h1>
            <div class="title-sub">
                ChatGPTï¼ˆã‚·ãƒ¼ã‚ºï¼‰Ã— Geminiï¼ˆãƒ‹ãƒ¼ã‚ºï¼‰Ã— æŠ€è¡“è€…ï¼ˆç¾å®Ÿï¼‰ã«ã‚ˆã‚‹ ææ–™ç ”ç©¶é–‹ç™ºæˆ¦ç•¥ å…±å‰µã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
            </div>
            <div class="role-pills">
                <div class="pill chatgpt"><span class="badge"></span>ChatGPTï¼šå…ˆç«¯ãƒ»å…ˆè¡Œç ”ç©¶ï¼ã‚·ãƒ¼ã‚ºè¦–ç‚¹</div>
                <div class="pill gemini"><span class="badge"></span>Geminiï¼šãƒ‹ãƒ¼ã‚ºè¦–ç‚¹ï¼å¸‚å ´ãƒ»ç’°å¢ƒãƒ»ç¤¾ä¼šã‚·ãƒŠãƒªã‚ª</div>
                <div class="pill engineer"><span class="badge"></span>æŠ€è¡“è€…ï¼šå¯¾è±¡é ˜åŸŸï¼ç¤¾å†…çŸ¥è¦‹ï¼å°†æ¥åƒ</div>
            </div>
        </div>
    </header>

    <!-- ====== CONFIG ====== -->
    <section class="config">
        <div class="config-block">
            <h2>APIè¨­å®šï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å†…ã§ã®ã¿ä½¿ç”¨ï¼ä¿å­˜ã¯ãƒ­ãƒ¼ã‚«ãƒ«ï¼‰</h2>
            <div class="field-row">
                <label for="openaiKey">OpenAI API Key</label>
                <input id="openaiKey" type="password" placeholder="sk-...">
            </div>
            <div class="field-row">
                <label for="openaiModel">ChatGPT Model</label>
                <input id="openaiModel" type="text" value="gpt-4.1-mini" />
            </div>
            <div class="field-row">
                <label for="geminiKey">Gemini API Key</label>
                <input id="geminiKey" type="password" placeholder="AIza...">
            </div>
            <div class="field-row">
                <label for="geminiModel">Gemini Model</label>
                <input id="geminiModel" type="text" value="gemini-1.5-flash" />
            </div>
            <div class="hint">
                â€» ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€æœ¬ç•ªç’°å¢ƒã§ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çµŒç”±ã§APIã‚’å‘¼ã³å‡ºã™æ§‹æˆãŒæ¨å¥¨ã€‚ã“ã“ã§ã¯æ¤œè¨¼ç”¨ã¨ã—ã¦ãƒ•ãƒ­ãƒ³ãƒˆå˜ä½“æ§‹æˆã‚’æƒ³å®šã€‚
            </div>
        </div>
        <div class="config-block">
            <h2>è­°è«–ã®èµ·ç‚¹ï¼ˆæœ€åˆã«æŠ€è¡“è€…ãŒå…¥åŠ›ï¼‰</h2>
            <div class="field-row">
                <label for="targetDomain">å¯¾è±¡ææ–™é ˜åŸŸ</label>
                <input id="targetDomain" type="text" placeholder="ä¾‹ï¼šå…¨å›ºä½“é›»æ± ç”¨å›ºä½“é›»è§£è³ªã€è§¦åª’ã€ç£æ€§ææ–™ãªã©">
            </div>
            <div class="field-row">
                <label for="internalStrength">ç¤¾å†…ã®å¼·ã¿ãƒ»çŸ¥è¦‹</label>
                <input id="internalStrength" type="text" placeholder="ä¾‹ï¼šç‰¹å®šãƒ—ãƒ­ã‚»ã‚¹è¨­å‚™ã€è§£ææŠ€è¡“ã€æ—¢å­˜ç‰¹è¨±ç¾¤ãªã©">
            </div>
            <div class="field-row">
                <label for="futureVision">å°†æ¥åƒãƒ»ã‚³ãƒ³ã‚»ãƒ—ãƒˆ</label>
                <input id="futureVision" type="text" placeholder="ä¾‹ï¼š2035å¹´ã®CNã€MaaSã€åœ°åŸŸé›»åŠ›ç¶²ã€ç½å®³ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹ç­‰">
            </div>
            <div class="hint">
                ã“ã®æƒ…å ±ã¯æœ€åˆã®ç™ºè©±ã«è‡ªå‹•ã§åŸ‹ã‚è¾¼ã‚€ã“ã¨ãŒã§ãã‚‹ã€‚<br>
                ã€Œçµ‚äº†ã€ã€Œçµ‚ã‚ã‚Šã€ã€Œend discussionã€ç­‰ã€ã‚‚ã—ãã¯å³ä¸‹ã®[è­°è«–ã‚’çµ‚äº†]ãƒœã‚¿ãƒ³ã§çµ‚äº†å®£è¨€ã€‚
            </div>
        </div>
    </section>

    <!-- ====== MAIN LAYOUT ====== -->
    <section class="main">
        <!-- === Chat Area === -->
        <div class="chat-panel">
            <div id="chatLog" class="chat-log"></div>
            <div class="input-bar">
                <textarea id="userInput" placeholder="æŠ€è¡“è€…ã¨ã—ã¦è©±ã—ã‹ã‘ã¦ãã ã•ã„ã€‚æœ€åˆã¯ã€ä»Šå›è­°è«–ã—ãŸã„ææ–™ç ”ç©¶é–‹ç™ºé ˜åŸŸã€ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚Shift+Enterã§æ”¹è¡Œã€Enterã§é€ä¿¡ã€‚"></textarea>
                <button id="micBtn" class="btn-mic" title="éŸ³å£°å…¥åŠ›ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®Web Speech APIä½¿ç”¨ï¼‰">
                    ğŸ¤ <span class="small-label">éŸ³å£°</span>
                </button>
                <button id="endBtn" class="btn-end" title="è­°è«–ã‚’çµ‚äº†ã—ã€Geminiã«è¦ç´„ï¼†ææ¡ˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚’æŒ‡ç¤º">
                    â–  çµ‚äº†
                </button>
                <button id="sendBtn" class="btn-send">
                    â é€ä¿¡
                </button>
            </div>
            <div style="margin-top:2px; display:flex; justify-content:space-between; align-items:center;">
                <div class="small-label" style="color:var(--muted);">
                    ä¼šè©±å±¥æ­´ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã€å„LLMå‘¼ã³å‡ºã—æ™‚ã«å…¨å±¥æ­´ã‚’å‚ç…§ã—ã¦ã€Œå¿˜ã‚Œãªã„ã€é‹ç”¨ã‚’è¡Œã†ã€‚
                </div>
                <button id="clearBtn" class="btn-clear" title="ä¼šè©±å±¥æ­´ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢">
                    ğŸ—‘ å±¥æ­´ã‚¯ãƒªã‚¢
                </button>
            </div>
        </div>

        <!-- === Sidebar: Logic & Status === -->
        <div class="sidebar">
            <div class="panel">
                <h3>ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¨­è¨ˆï¼ˆæ¦‚è¦ï¼‰</h3>
                <p>
                    <span class="status-dot status-ok"></span>
                    <strong>ChatGPTï¼ˆã‚·ãƒ¼ã‚ºå´ï¼‰</strong>ï¼šæŒ‡å®šææ–™é ˜åŸŸã®å…ˆç«¯ã€œå…ˆè¡Œç ”ç©¶ã€èµ·æºã‹ã‚‰ã®æŠ€è¡“å²ã€ç†è«–çš„èƒŒæ™¯ã€ä¸»è¦è«–æ–‡ãƒ»ç‰¹è¨±ãƒ»å›½éš›ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç­‰ã‚’æ•´ç†ã—ã€<u>ç¤¾å†…ã®æ—¢å­˜è³‡ç”£ã¨æ¥ç¶šå¯èƒ½ãªã‚·ãƒ¼ã‚ºç¾¤</u>ã‚’æŠ½å‡ºã™ã‚‹ã€‚
                </p>
                <p>
                    <span class="status-dot status-ok"></span>
                    <strong>Geminiï¼ˆãƒ‹ãƒ¼ã‚ºå´ï¼‰</strong>ï¼šä¸–ç•Œã®è¦åˆ¶ãƒ»å¸‚å ´ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ»è‡ªç„¶ç’°å¢ƒãƒ»åœ°æ”¿å­¦ãƒ»ç¤¾ä¼šè¦è«‹ã‚’è¸ã¾ãˆã€2030â€“2040å¹´ä»£ã®<u>å‡ºå£ã‚·ãƒŠãƒªã‚ªãƒ»æƒ³å®šé¡§å®¢ãƒ»ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹</u>ã‚’æ§‹æˆã™ã‚‹ã€‚
                </p>
                <p>
                    <span class="status-dot status-ok"></span>
                    <strong>æŠ€è¡“è€…</strong>ï¼šç¤¾å†…å®Ÿæƒ…ãƒ»åˆ¶ç´„ãƒ»å¼·ã¿ãƒ»çµŒå–¶æ–¹é‡ã‚’ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã—ã€ä¸¡AIã«ä¿®æ­£ãƒ»æ·±æ˜ã‚Šã‚’è¦æ±‚ã—ãªãŒã‚‰ã€å®Ÿè£…å¯èƒ½ãªæ–°ãƒ†ãƒ¼ãƒï¼æ–°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å…±å‰µã™ã‚‹ã€‚
                </p>
            </div>
            <div class="panel">
                <h3>ChatGPTç”¨ System Promptï¼ˆè¦æ—¨ï¼‰</h3>
                <code id="chatgptPromptPreview"></code>
            </div>
            <div class="panel">
                <h3>Geminiç”¨ System Promptï¼ˆè¦æ—¨ï¼‰</h3>
                <code id="geminiPromptPreview"></code>
            </div>
        </div>
    </section>
</div>

<!-- ====== JS ====== -->
<script>
/**
 * Materials Strategy Tri-Agent Studio
 * - 3è€…: ChatGPT / Gemini / Engineer
 * - ä¼šè©±å±¥æ­´ã‚’å¸¸ã«å…¨ãƒ¢ãƒ‡ãƒ«ã¸æ¸¡ã—ã€localStorageã«ã‚‚ä¿å­˜ã—ã¦ã€Œå¿˜ã‚Œãªã„ã€æ§‹æˆ
 * - çµ‚äº†å®£è¨€å¾Œã¯ Gemini ã«ã‚ˆã‚‹è¦ç´„ï¼‹ææ¡ˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
 * - APIã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§ã®ã¿åˆ©ç”¨ï¼ˆæœ¬ç•ªã§ã¯å¿…ãšã‚µãƒ¼ãƒå´ã§ä¿è­·ã™ã‚‹ã“ã¨ï¼‰
 */

const chatLogEl = document.getElementById('chatLog');
const userInputEl = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const endBtn = document.getElementById('endBtn');
const micBtn = document.getElementById('micBtn');
const clearBtn = document.getElementById('clearBtn');

const openaiKeyEl = document.getElementById('openaiKey');
const openaiModelEl = document.getElementById('openaiModel');
const geminiKeyEl = document.getElementById('geminiKey');
const geminiModelEl = document.getElementById('geminiModel');

const targetDomainEl = document.getElementById('targetDomain');
const internalStrengthEl = document.getElementById('internalStrength');
const futureVisionEl = document.getElementById('futureVision');

const chatgptPromptPreview = document.getElementById('chatgptPromptPreview');
const geminiPromptPreview = document.getElementById('geminiPromptPreview');

let conversation = []; // {speaker: 'engineer'|'chatgpt'|'gemini'|'system', text: string}
let discussionEnded = false;
let recognition = null;
let isRecording = false;

const STORAGE_KEY = 'tri_agent_materials_conversation_v1';

// ===== System Prompts =====
const chatgptSystemPrompt = `
ã‚ãªãŸã¯ã€Œã‚·ãƒ¼ã‚ºãƒ‰ãƒªãƒ–ãƒ³ã®å…ˆç«¯ãƒ»å…ˆè¡Œææ–™ç ”ç©¶ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€ã§ã‚ã‚‹ã€‚
å½¹å‰²:
1. æŠ€è¡“è€…ãŒæŒ‡å®šã—ãŸææ–™ç ”ç©¶é–‹ç™ºé ˜åŸŸã«ã¤ã„ã¦ã€æœ€æ–°ã®å­¦è¡“è«–æ–‡ãƒ»ç‰¹è¨±ãƒ»å¤§å‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»æ¨™æº–åŒ–å‹•å‘ãªã©ã€ç§‘å­¦çš„ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ã«åŸºã¥ãä½“ç³»çš„ã«æ•´ç†ã™ã‚‹ã€‚
2. æ­´å²çš„ãªæŠ€è¡“é€²åŒ–ãƒ‘ã‚¹ï¼ˆã©ã®æ§˜ãªç†è«–ãƒ»ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¹ãƒ«ãƒ¼ã‚’çµŒã¦ç¾åœ¨ã®ãƒ•ãƒ­ãƒ³ãƒ†ã‚£ã‚¢ã«è‡³ã£ãŸã‹ï¼‰ã‚’ç°¡æ½”ã«ç¤ºã™ã€‚
3. æŠ€è¡“è€…ãŒæä¾›ã™ã‚‹ç¤¾å†…çŸ¥è¦‹ãƒ»è¨­å‚™ãƒ»çŸ¥è²¡ãƒ»äººæãªã©ã®å¼·ã¿æƒ…å ±ã‚’èª­ã¿å–ã‚Šã€ã€Œç¤¾å†…ã®å¼·ã¿ãŒãƒ¬ãƒãƒ¬ãƒƒã‚¸ã•ã‚Œã‚‹å…·ä½“çš„ã‚·ãƒ¼ã‚ºå€™è£œã€ã‚’åˆ—æŒ™ã—ã€æ ¹æ‹ ã‚’ç¤ºã™ã€‚
4. Geminiï¼ˆãƒ‹ãƒ¼ã‚ºå´ï¼‰ã®ææ¡ˆã¨æŠ€è¡“è€…ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¸ã¾ãˆã€ã€Œã©ã®ã‚·ãƒ¼ã‚ºãŒæˆ¦ç•¥çš„ã«é‡è¦ã‹ã€ã€Œä½•ã‚’æ·±æ˜ã‚Šã™ã¹ãã‹ã€ã‚’å¯¾è©±çš„ã«æ›´æ–°ã™ã‚‹ã€‚
å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«:
- æ—¥æœ¬èªã§å›ç­”ã€‚
- ç®‡æ¡æ›¸ãã¯æœ‰åŠ¹ã«ä½¿ã†ãŒã€å˜ãªã‚‹è¦ç´„ã§ãªãã€æ ¹æ‹ ãƒ»ä»£è¡¨ä¾‹ãƒ»å‚è€ƒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¯å›å«ã‚ã‚‹ã€‚
- æŠ€è¡“è€…ãŒã€Œçµ‚äº†ã€ã¨æ˜ç¤ºã™ã‚‹ã¾ã§ã¯ã€æ–°ãƒ†ãƒ¼ãƒææ¡ˆã‚’æ€¥ã„ã§ç¢ºå®šã•ã›ãšã€æ¢ç´¢ç©ºé–“ã‚’æ•´ç†ã—ç¶šã‘ã‚‹ã€‚
`;

const geminiSystemPrompt = `
ã‚ãªãŸã¯ã€Œãƒ‹ãƒ¼ã‚ºãƒ‰ãƒªãƒ–ãƒ³ã®ææ–™æˆ¦ç•¥ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€ã§ã‚ã‚‹ã€‚
å½¹å‰²:
1. æŠ€è¡“è€…ãŒç¤ºã™å°†æ¥åƒãƒ»ç¤¾ä¼šèª²é¡Œãƒ»äº‹æ¥­æˆ¦ç•¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚‚ã¨ã«ã€ä¸–ç•Œã®å¸‚å ´å‹•å‘ã€è¦åˆ¶ã€åœ°æ”¿å­¦ã€è‡ªç„¶ç’°å¢ƒåˆ¶ç´„ã€ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³ã€é¡§å®¢è¡Œå‹•ã‚’è¸ã¾ãˆãŸã€Œå‡ºå£ã‚·ãƒŠãƒªã‚ªã€ã‚’è¨­è¨ˆã™ã‚‹ã€‚
2. ChatGPTãŒæ•´ç†ã—ãŸã‚·ãƒ¼ã‚ºæƒ…å ±ã¨çµ„ã¿åˆã‚ã›ã¦ã€ã€Œã©ã®ç”¨é€”ãƒ»èª°ã®èª²é¡Œãƒ»ã©ã®åœ°åŸŸãƒ»ã©ã®ã‚¤ãƒ³ãƒ•ãƒ©ã§ä½¿ã‚ã‚Œã‚‹æŠ€è¡“ã‹ã€ã‚’å…·ä½“çš„ã«æå†™ã™ã‚‹ã€‚
3. æŠ€è¡“è€…ãŒæç¤ºã™ã‚‹ç¤¾å†…å¼·ã¿ã‚’å°Šé‡ã—ã€ã€Œç¾å®Ÿçš„ã«å–ã‚Šå¾—ã‚‹ãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ã€ã¨ã€Œé«˜é›£åº¦ã ãŒæˆ¦ç•¥çš„ä¾¡å€¤ãŒå¤§ãã„æŒ‘æˆ¦é ˜åŸŸã€ã‚’åˆ†ã‘ã¦ææ¡ˆã™ã‚‹ã€‚
4. æŠ€è¡“è€…ãŒã€Œçµ‚äº†ã€ã¨å®£è¨€ã—ãŸå¾Œ:
   - ãã‚Œã¾ã§ã®å…¨å¯¾è©±ã‚’è¸ã¾ãˆã€(a)è­°è«–ã‚µãƒãƒª (b)æ–°ãƒ†ãƒ¼ãƒãƒ»æ–°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¡ˆ (c)æ¨å¥¨ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ— (d)ãƒªã‚¹ã‚¯ã¨Next Action ã‚’å«ã‚€ææ¡ˆãƒ¬ãƒãƒ¼ãƒˆã‚’æ—¥æœ¬èªã§å‡ºåŠ›ã™ã‚‹ã€‚
å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«:
- æ—¥æœ¬èªã§å›ç­”ã€‚
- å¯èƒ½ãªé™ã‚Šå®šé‡ãƒ»æ ¹æ‹ ãƒ»å¤–éƒ¨ç’°å¢ƒè¦å› ã‚’ç¹”ã‚Šè¾¼ã‚€ã€‚
- å¯¾è©±ä¸­ã¯çµè«–ã‚’ä¸€ã¤ã«å›ºå®šã›ãšã€é¸æŠè‚¢ã¨å«æ„ã‚’æç¤ºã—ã¤ã¤æŠ€è¡“è€…ã«å•ã„è¿”ã™ã€‚
`;

// Show brief previews in sidebar
chatgptPromptPreview.textContent = trimForPreview(chatgptSystemPrompt, 340);
geminiPromptPreview.textContent = trimForPreview(geminiSystemPrompt, 340);

function trimForPreview(text, maxLen) {
    const t = text.trim().replace(/\s+/g, ' ');
    return t.length > maxLen ? t.slice(0, maxLen) + ' ...' : t;
}

// ===== Conversation Persistence =====
function saveConversation() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
            conversation,
            targetDomain: targetDomainEl.value || '',
            internalStrength: internalStrengthEl.value || '',
            futureVision: futureVisionEl.value || ''
        }));
    } catch (e) {
        console.warn('Failed to save conversation', e);
    }
}

function loadConversation() {
    try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
            appendSystemMessage(
                'æœ€åˆã«ã€Œä»Šå›è­°è«–ã—ãŸã„ææ–™ç ”ç©¶é–‹ç™ºé ˜åŸŸã€ã‚’æŠ€è¡“è€…ã¨ã—ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚' +
                '\nä¾‹ï¼šã€Œå…¨å›ºä½“é›»æ± ç”¨ç¡«åŒ–ç‰©ç³»å›ºä½“é›»è§£è³ªã«ã¤ã„ã¦è­°è«–ã—ãŸã„ã€'
            );
            return;
        }
        const data = JSON.parse(raw);
        if (Array.isArray(data.conversation)) {
            conversation = data.conversation;
            conversation.forEach(msg => renderMessage(msg.speaker, msg.text, true));
        }
        if (data.targetDomain) targetDomainEl.value = data.targetDomain;
        if (data.internalStrength) internalStrengthEl.value = data.internalStrength;
        if (data.futureVision) futureVisionEl.value = data.futureVision;
        scrollToBottom();
    } catch (e) {
        console.warn('Failed to load conversation', e);
    }
}

// ===== Rendering =====
function renderMessage(speaker, text, skipPush = false) {
    const row = document.createElement('div');
    row.className = 'msg-row';

    const msg = document.createElement('div');
    msg.classList.add('msg');

    const header = document.createElement('div');
    header.className = 'msg-header';
    const dot = document.createElement('span');
    dot.className = 'dot';

    let label = '';
    if (speaker === 'engineer') {
        msg.classList.add('engineer');
        label = 'æŠ€è¡“è€…';
    } else if (speaker === 'chatgpt') {
        msg.classList.add('chatgpt');
        label = 'ChatGPTï¼ˆã‚·ãƒ¼ã‚ºå´ï¼‰';
    } else if (speaker === 'gemini') {
        msg.classList.add('gemini');
        label = 'Geminiï¼ˆãƒ‹ãƒ¼ã‚ºå´ï¼‰';
    } else {
        msg.classList.add('system');
        label = 'System';
    }

    header.appendChild(dot);
    header.appendChild(document.createTextNode(label));
    msg.appendChild(header);
    msg.appendChild(document.createTextNode(text));
    row.appendChild(msg);
    chatLogEl.appendChild(row);
    scrollToBottom();

    if (!skipPush) {
        conversation.push({ speaker, text });
        saveConversation();
    }
}

function appendSystemMessage(text) {
    renderMessage('system', text);
}
function appendEngineerMessage(text) {
    renderMessage('engineer', text);
}
function appendChatGPTMessage(text) {
    renderMessage('chatgpt', text);
}
function appendGeminiMessage(text) {
    renderMessage('gemini', text);
}

function scrollToBottom() {
    requestAnimationFrame(() => {
        chatLogEl.scrollTop = chatLogEl.scrollHeight;
    });
}

// ===== Input Handling =====
sendBtn.addEventListener('click', handleUserInput);

userInputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleUserInput();
    }
});

function buildInitialContextIfEmpty() {
    if (conversation.length === 0) {
        const td = targetDomainEl.value?.trim();
        const isVal = internalStrengthEl.value?.trim();
        const fv = futureVisionEl.value?.trim();
        if (td) {
            let seed = `ã€å‰æå…±æœ‰ã€‘\nä»Šå›è­°è«–ã—ãŸã„ææ–™ç ”ç©¶é–‹ç™ºé ˜åŸŸï¼š${td}`;
            if (isVal) seed += `\nç¤¾å†…ã®å¼·ã¿ãƒ»çŸ¥è¦‹ï¼š${isVal}`;
            if (fv) seed += `\nå°†æ¥åƒãƒ»ã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼š${fv}`;
            appendEngineerMessage(seed);
        }
    }
}

async function handleUserInput() {
    if (discussionEnded) {
        appendSystemMessage('ã™ã§ã«è­°è«–ã¯çµ‚äº†ã—ã¦ã„ã¾ã™ã€‚æ–°ãŸã«é–‹å§‹ã™ã‚‹å ´åˆã¯å±¥æ­´ã‚¯ãƒªã‚¢ã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    buildInitialContextIfEmpty();

    const text = userInputEl.value.trim();
    if (!text) return;
    userInputEl.value = '';
    appendEngineerMessage(text);

    const lowered = text.toLowerCase();
    if (/[çµ‚äº†çµ‚ã‚ã‚Šçµ‚çµ]/.test(text) || lowered.includes('end discussion')) {
        // treat as explicit end signal
        await endDiscussion();
    } else {
        await triAgentTurn();
    }
}

// ===== Tri-Agent Turn =====
async function triAgentTurn() {
    // 1) ChatGPTã‚·ãƒ¼ã‚ºå´ â†’ 2) Geminiãƒ‹ãƒ¼ã‚ºå´ ã®é †ã«å‘¼ã³å‡ºã—
    await callChatGPTAgent();
    await callGeminiAgent();
}

// Build messages for OpenAI Chat Completions
function buildChatGPTMessages() {
    const messages = [
        { role: 'system', content: chatgptSystemPrompt.trim() }
    ];
    for (const m of conversation) {
        if (m.speaker === 'engineer') {
            messages.push({ role: 'user', content: m.text });
        } else if (m.speaker === 'chatgpt') {
            messages.push({ role: 'assistant', content: `[ChatGPT] ${m.text}` });
        } else if (m.speaker === 'gemini') {
            messages.push({ role: 'assistant', content: `[Gemini] ${m.text}` });
        } else if (m.speaker === 'system') {
            // system messages already exist; optionally embed as assistant
            messages.push({ role: 'assistant', content: `[System] ${m.text}` });
        }
    }
    return messages;
}

// Build contents for Gemini generateContent
function buildGeminiContents() {
    const contents = [];
    for (const m of conversation) {
        if (m.speaker === 'engineer') {
            contents.push({ role: 'user', parts: [{ text: m.text }] });
        } else if (m.speaker === 'chatgpt' || m.speaker === 'gemini' || m.speaker === 'system') {
            contents.push({ role: 'model', parts: [{ text: `[${m.speaker.toUpperCase()}] ${m.text}` }] });
        }
    }
    if (contents.length === 0) {
        contents.push({
            role: 'user',
            parts: [{ text: 'æŠ€è¡“è€…ã‹ã‚‰ã®å…¥åŠ›ã‚’å¾…ã£ã¦ã„ã¾ã™ã€‚' }]
        });
    }
    return contents;
}

// ===== Call ChatGPT =====
async function callChatGPTAgent() {
    const apiKey = openaiKeyEl.value.trim();
    const model = (openaiModelEl.value || '').trim() || 'gpt-4.1-mini';

    if (!apiKey) {
        appendSystemMessage('ChatGPTç”¨ã® OpenAI API Key ãŒæœªè¨­å®šã®ãŸã‚ã€ã‚·ãƒ¼ã‚ºå´å¿œç­”ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ãŸã€‚');
        return;
    }
    appendSystemMessage('ChatGPTãŒå…ˆç«¯ãƒ»å…ˆè¡Œç ”ç©¶ã®è¦³ç‚¹ã‹ã‚‰æ•´ç†ä¸­...');

    try {
        const body = {
            model,
            messages: buildChatGPTMessages(),
            temperature: 0.7
        };

        const res = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + apiKey
            },
            body: JSON.stringify(body)
        });

        const data = await res.json();
        const text =
            data?.choices?.[0]?.message?.content?.trim() ||
            'ChatGPTå´ã®å¿œç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        appendChatGPTMessage(text);
    } catch (err) {
        console.error(err);
        appendSystemMessage('ChatGPTå‘¼ã³å‡ºã—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }
}

// ===== Call Gemini (turn mode) =====
async function callGeminiAgent() {
    const apiKey = geminiKeyEl.value.trim();
    const model = (geminiModelEl.value || '').trim() || 'gemini-1.5-flash';

    if (!apiKey) {
        appendSystemMessage('Geminiç”¨ã® API Key ãŒæœªè¨­å®šã®ãŸã‚ã€ãƒ‹ãƒ¼ã‚ºå´å¿œç­”ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ãŸã€‚');
        return;
    }
    appendSystemMessage('GeminiãŒå‡ºå£ã‚·ãƒŠãƒªã‚ªã¨é¡§å®¢åƒã®è¦³ç‚¹ã‹ã‚‰æ•´ç†ä¸­...');

    try {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(model)}:generateContent?key=${encodeURIComponent(apiKey)}`;
        const body = {
            system_instruction: {
                role: 'user',
                parts: [{ text: geminiSystemPrompt.trim() }]
            },
            contents: buildGeminiContents(),
            generationConfig: {
                temperature: 0.7
            }
        };

        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        const data = await res.json();
        const text =
            data?.candidates?.[0]?.content?.parts?.map(p => p.text || '').join('').trim() ||
            'Geminiå´ã®å¿œç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        appendGeminiMessage(text);
    } catch (err) {
        console.error(err);
        appendSystemMessage('Geminiå‘¼ã³å‡ºã—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }
}

// ===== Discussion End & Summary Report =====
endBtn.addEventListener('click', () => {
    if (discussionEnded) {
        appendSystemMessage('ã™ã§ã«çµ‚äº†å‡¦ç†ã¯å®Ÿè¡Œæ¸ˆã¿ã§ã™ã€‚');
        return;
    }
    endDiscussion();
});

async function endDiscussion() {
    discussionEnded = true;
    appendSystemMessage('æŠ€è¡“è€…ã‹ã‚‰ã®çµ‚äº†å®£è¨€ã‚’å—ä¿¡ã€‚Geminiã«è­°è«–ã‚µãƒãƒªã¨ææ¡ˆãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆã‚’æŒ‡ç¤ºã—ã¾ã™ã€‚');

    const apiKey = geminiKeyEl.value.trim();
    const model = (geminiModelEl.value || '').trim() || 'gemini-1.5-flash';
    if (!apiKey) {
        appendSystemMessage('Gemini API Key ãŒæœªè¨­å®šã®ãŸã‚ã€çµ‚äº†ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã€‚ã‚­ãƒ¼è¨­å®šå¾Œã«å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        return;
    }

    try {
        const transcript = conversation
            .map(m => `${m.speaker.toUpperCase()}: ${m.text}`)
            .join('\n');

        const prompt = `
ã‚ãªãŸã¯ãƒ‹ãƒ¼ã‚ºãƒ‰ãƒªãƒ–ãƒ³ææ–™æˆ¦ç•¥ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã—ã¦è¡Œã£ã¦ããŸä¸‰è€…å¯¾è©±ã‚’ç·æ‹¬ã™ã‚‹ã€‚
ä»¥ä¸‹ã®å¯¾è©±ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ã€æ—¥æœ¬èªã§A4ãƒ¬ãƒãƒ¼ãƒˆ1ã€œ2æšç¨‹åº¦ã®æ§‹æˆã§å‡ºåŠ›ã›ã‚ˆã€‚

è¦ä»¶:
1. ã€Œè­°è«–ã‚µãƒãƒªã€: ã‚·ãƒ¼ã‚ºå´(ChatGPT)ã€ãƒ‹ãƒ¼ã‚ºå´(Gemini)ã€æŠ€è¡“è€…ã®ä¸»å¼µãƒ»ç¤ºå”†ã‚’æ•´ç†ã€‚
2. ã€Œæ–°ãƒ†ãƒ¼ãƒæ¡ˆã€: 3ã€œ7ä»¶ç¨‹åº¦ã€‚å„ãƒ†ãƒ¼ãƒã«ã¤ã„ã¦
   - ç‹™ã†ä¾¡å€¤ï¼ˆå¸‚å ´ãƒ»ç¤¾ä¼šãƒ»ç’°å¢ƒï¼‰
   - ã‚³ã‚¢æŠ€è¡“è¦ç´ ï¼ˆææ–™ãƒ»ãƒ—ãƒ­ã‚»ã‚¹ãƒ»ãƒ‡ãƒ¼ã‚¿ï¼‰
   - ç¤¾å†…å¼·ã¿ã¨ã®æ•´åˆãƒ»ãƒ¬ãƒãƒ¬ãƒƒã‚¸ãƒã‚¤ãƒ³ãƒˆ
   - æƒ³å®šTRL/æ™‚é–“è»¸
3. ã€Œæ–°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆæ¡ˆã€: ä¸Šè¨˜ãƒ†ãƒ¼ãƒã®ä¸­ã‹ã‚‰å„ªå…ˆå€™è£œã‚’é¸ã³ã€
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼ˆä»®ï¼‰
   - ãƒ•ã‚§ãƒ¼ã‚ºæ§‹æˆ (0:æ¢ç´¢ã€œ5:é‡ç”£é©ç”¨ãªã©)
   - å¿…è¦ãªç¤¾å†…/å¤–éƒ¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼
   - æˆæœæŒ‡æ¨™ (æŠ€è¡“æŒ‡æ¨™ï¼‹äº‹æ¥­æŒ‡æ¨™) ã‚’è¨˜è¼‰ã€‚
4. ã€Œæ¬¡ã«å–ã‚‹ã¹ãå…·ä½“ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€: 3ã€œ10å€‹ã€‚
5. å…¨ä½“ã¨ã—ã¦ã€å¤§ä¼æ¥­ææ–™ç ”ç©¶éƒ¨é–€ã®çµŒå–¶å±¤ãƒ»éƒ¨é–€é•·ã«ãã®ã¾ã¾æç¤ºã§ãã‚‹ãƒ¬ãƒ™ãƒ«ã§ã€è«–ç†çš„ãƒ»ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«ã¾ã¨ã‚ã‚‹ã€‚

ã€å¯¾è©±ãƒ­ã‚°ã€‘
${transcript}
        `.trim();

        const url = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(model)}:generateContent?key=${encodeURIComponent(apiKey)}`;
        const body = {
            system_instruction: {
                role: 'user',
                parts: [{ text: geminiSystemPrompt.trim() }]
            },
            contents: [
                { role: 'user', parts: [{ text: prompt }] }
            ],
            generationConfig: {
                temperature: 0.6
            }
        };

        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        const data = await res.json();
        const text =
            data?.candidates?.[0]?.content?.parts?.map(p => p.text || '').join('').trim() ||
            'Geminiã‹ã‚‰è¦ç´„ãƒ¬ãƒãƒ¼ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';

        // Summary is treated as Gemini (Report)
        renderMessage('gemini', 'ã€æœ€çµ‚ææ¡ˆãƒ¬ãƒãƒ¼ãƒˆã€‘\n' + text);
    } catch (err) {
        console.error(err);
        appendSystemMessage('çµ‚äº†ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    } finally {
        saveConversation();
    }
}

// ===== Clear Conversation =====
clearBtn.addEventListener('click', () => {
    if (!confirm('å…¨ã¦ã®ä¼šè©±å±¥æ­´ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    conversation = [];
    discussionEnded = false;
    chatLogEl.innerHTML = '';
    localStorage.removeItem(STORAGE_KEY);
    appendSystemMessage('å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚æ–°ã—ã„è­°è«–ã‚’é–‹å§‹ã§ãã¾ã™ã€‚');
});

// ===== Speech Recognition (Web Speech API) =====
function initSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        appendSystemMessage('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›(Web Speech API)ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
        micBtn.disabled = true;
        return;
    }
    recognition = new SpeechRecognition();
    recognition.lang = 'ja-JP';
    recognition.continuous = false;
    recognition.interimResults = true;

    recognition.onstart = () => {
        isRecording = true;
        micBtn.classList.add('recording');
        micBtn.textContent = 'â— éŒ²éŸ³ä¸­';
    };
    recognition.onerror = () => {
        isRecording = false;
        micBtn.classList.remove('recording');
        micBtn.textContent = 'ğŸ¤ éŸ³å£°';
    };
    recognition.onend = () => {
        isRecording = false;
        micBtn.classList.remove('recording');
        micBtn.textContent = 'ğŸ¤ éŸ³å£°';
    };
    recognition.onresult = (event) => {
        let finalTranscript = '';
        let interimTranscript = '';
        for (let i = 0; i < event.results.length; ++i) {
            const trans = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += trans;
            } else {
                interimTranscript += trans;
            }
        }
        if (interimTranscript) {
            userInputEl.value = (userInputEl.value + ' ' + interimTranscript).trim();
        }
        if (finalTranscript) {
            userInputEl.value = (userInputEl.value + ' ' + finalTranscript).trim();
        }
    };
}

micBtn.addEventListener('click', () => {
    if (!recognition) {
        initSpeechRecognition();
        if (!recognition) return;
    }
    if (isRecording) {
        recognition.stop();
    } else {
        recognition.start();
    }
});

// ===== Init =====
loadConversation();
initSpeechRecognition();
</script>
</body>
</html>
